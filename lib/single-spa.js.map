{"version":3,"file":"single-spa.js","sources":["../src/application/app.helpers.js","../src/start.js","../src/lifecycles/load.js","../src/lifecycles/unmount.js","../src/lifecycles/bootstrap.js","../src/lifecycles/mount.js","../src/navigations/navigator-events.js","../src/navigations/reroute.js","../src/application/app.js","../src/sub/index.js"],"sourcesContent":["// 描述应用的整个状态\nexport const NOT_LOADED = 'NOT_LOADED' // 应用初始状态\nexport const LOADING_SOURCE_CODE = 'LOADING_SOURCE_CODE' // 加载资源\nexport const NOT_BOOTSTRAPPED = 'NOT_BOOTSTRAPPED' // 还没有调用bootstrap方法\nexport const BOOTSTRAPPING = 'BOOTSTRAPPING' // 启动中\nexport const NOT_MOUNTED = 'NOT_MOUNTED' // 没有调用mount方法\nexport const MOUNTING = 'MOUNTING' // 正在挂载中\nexport const MOUNTED = 'MOUNTED' // 挂载完毕\nexport const UPDATINMG = 'UPDATINMG' // 更新中\nexport const UNMOUNTING = 'UNMOUNTING' // 解除挂载\nexport const UNLOADING = 'UNLOADING'// 完全卸载中\nexport const LOAD_ERR = 'LOAD_ERR'\nexport const SKIP_BECAUSE_BROKEN = 'SKIP_BECAUSE_BROKEN'\n\n// 当前应用是否被激活\nexport function isActive(app) {\n    return app.status === MOUNTED\n}\n// 当前这个应用是否要被激活\nexport function shouldBeActive(app) { //如果返回true 那么应用应该就开始初始化等一系列操作\n    return app.activeWhen(window.location)\n}","import { reroute } from \"./navigations/reroute\";\n\nexport let started = false\nexport function start() {\n    // 挂载应用\n    started = true\n    reroute() // 除了去加载应用，还需要去挂载应用\n}","import { LOADING_SOURCE_CODE, NOT_BOOTSTRAPPED } from \"../application/app.helpers\"\n\n/**\n * 数组函数\n * @param {*} fns \n */\nfunction flattenFnArray(fns) {\n    fns = Array.isArray(fns) ? fns : [fns]\n    // 通过promise链来链式调用  多个方法组合成一个方法\n    return (props) => fns.reduce((p, fn) => p.then(() => fn(props)), Promise.resolve())\n}\n\n\n/**\n * @param {*} app \n */\nexport async function toLoadPromise(app) {\n    if (app.loadPromise) {\n        return app.loadPromise //缓存机制\n    }\n    return (app.loadPromise = Promise.resolve().then(async () => {\n        app.status = LOADING_SOURCE_CODE\n        let { bootstrap, mount, unmount } = await app.loadApp(app.customProps)\n        app.status = NOT_BOOTSTRAPPED // 没有调用bootstrap方法\n        // 我希望将多个promise组合在一起 compose\n        app.bootstrap = flattenFnArray(bootstrap)\n        app.mount = flattenFnArray(mount)\n        app.unmount = flattenFnArray(unmount)\n        delete app.loadPromise\n        return app\n    }))\n}","import { MOUNTED, UNMOUNTING, NOT_MOUNTED } from \"../application/app.helpers\"\n\n/**\n * @param {*} app \n */\nexport async function toUnmountPromise(app) {\n    // 当前应用没有被挂载直接什么都不做了\n    if (app.status != MOUNTED) {\n        return app\n    }\n    app.status = UNMOUNTING\n    await app.unmount(app.customProps)\n    app.status = NOT_MOUNTED\n    return app\n}","import { NOT_BOOTSTRAPPED, BOOTSTRAPPING, NOT_MOUNTED } from \"../application/app.helpers\";\n\n/**\n * @param {*} app \n */\nexport async function toBootstrapPromise(app) {\n    if (app.status !== NOT_BOOTSTRAPPED) {\n        return app\n    }\n    app.status = BOOTSTRAPPING\n    await app.bootstrap(app.customProps)\n    app.status = NOT_MOUNTED\n    return app\n}","import { NOT_MOUNTED, MOUNTING, MOUNTED } from \"../application/app.helpers\"\n\n/**\n * \n * @param {} app \n */\nexport async function toMountPromise(app){\n    if(app.status !== NOT_MOUNTED){\n        return app\n    }\n    app.status = MOUNTING\n    await app.mount(app.customProps);\n    app.status = MOUNTED\n    return app\n}\n\n\n","// hashchange   popstate\n\nimport { reroute } from \"./reroute\"\n\nexport const routingEventsListeningTo = ['hashchange', 'popstate']\n\n\nconst capturedEventListeners = { // 后续挂载的事件先暂存起来\n    hashchange: [],\n    popstate: [] // 当应用切换完成后可以调用\n}\n\nfunction urlReroute() {\n    reroute([], arguments); // 会根据路径重新加载不同的应用\n    capturedEventListeners.hashchange.forEach((fn) => {\n        if (fn) {\n            fn()\n        }\n    })\n    capturedEventListeners.popstate.forEach((fn) => {\n        if (fn) {\n            fn()\n        }\n    })\n}\n\n// 我们处理应用加载的逻辑是在最前面\nwindow.addEventListener('hashchange', urlReroute)\nwindow.addEventListener('popstate', urlReroute)\nconst originalAddEventListener = window.addEventListener\nconst originalRemoveEventListener = window.removeEventListener\nwindow.addEventListener = function (eventName, fn) {\n    if (routingEventsListeningTo.indexOf(eventName) >= 0 && !capturedEventListeners[eventName].some(listener => listener == fn)) {\n        capturedEventListeners[eventName].push(fn)\n        return\n    }\n    \n    return originalAddEventListener.apply(this, arguments)\n}\nwindow.removeEventListener = function (eventName, fn) {\n    if (routingEventsListeningTo.indexOf(eventName) >= 0) {\n        capturedEventListeners[eventName] = capturedEventListeners[eventName].filter(l => l !== fn)\n        return\n    }\n    return originalRemoveEventListener.apply(this, arguments)\n}\n\n// 如果是hash路由 hash变化时可以切换 \n// 浏览器路由，浏览器路由是h5api的 如果切换时不会触发popstate\n\nfunction patchedUpdateState(updateState, methodName) {\n    return function () {\n        const urlBefore = window.location.href\n        updateState.apply(this, arguments); // 调用切换方法\n        const urlAfter = window.location.href\n\n        if (urlBefore !== urlAfter) {\n            // 重新加载应用 传入事件源\n            urlReroute(new PopStateEvent('popstate'))\n        }\n    }\n}\n\n\nwindow.history.pushState = patchedUpdateState(window.history.pushState, 'pushState')\nwindow.history.replaceState = patchedUpdateState(window.history.replaceState, 'replaceState')\n\n// 用户可能还会绑定自己的路由事件 vue\n\n\n// 当我们应用切换后，还需要处理原来的方法，需要在应用切换后在执行","import { started } from '../start.js'\nimport { getAppChanges } from \"../application/app.js\"\nimport { toLoadPromise } from '../lifecycles/load.js'\nimport { toUnmountPromise } from \"../lifecycles/unmount\"\nimport { toBootstrapPromise } from \"../lifecycles/bootstrap\"\nimport { toMountPromise } from \"../lifecycles/mount\"\n\nimport './navigator-events'\n\n\n// 核心应用处理方法\nexport function reroute() {\n    //  需要获取要加载的应用\n    //  需要获取要被挂载的应用\n    //  哪些应用需要被卸载\n    const { appsToLoad, appsToMount, appsToUnmount } = getAppChanges()\n    // start方法调用时是同步的，但是加载流程是异步饿\n    if (started) {\n        // app装载\n        return performAppChanges()\n    } else {\n        // 注册应用时 需要预先加载\n        return loadApps()\n    }\n    async function loadApps() { // 预加载应用\n        let apps = await Promise.all(appsToLoad.map(toLoadPromise)) // 就是获取到bootstrap,mount和unmount方法放到app上\n        console.log(apps)\n    }\n    async function performAppChanges() { // 根据路径来装载应用\n        // 先卸载不需要的应用 \n        let unmountPromises = appsToUnmount.map(toUnmountPromise) // 需要去卸载的app\n        // 去加载需要的应用\n\n        // 这个应用可能需要加载 但是路径不匹配  加载app1 的时候，这个时候切换到了app2\n        appsToLoad.map(async (app) => { // 将需要求加载的应用拿到 => 加载 => 启动 => 挂载\n            app = await toLoadPromise(app)\n            app = await toBootstrapPromise(app)\n            return toMountPromise(app)\n        })\n        appsToMount.map(async (app) => {\n            app = await toBootstrapPromise(app)\n            return toMountPromise(app)\n        });\n    }\n}\n\n\n// 这个流程是用于初始化操作的，我们还需要 当路径切换时重新加载应用\n// 重写路由相关的方法","import { NOT_LOADED, SKIP_BECAUSE_BROKEN, shouldBeActive, LOADING_SOURCE_CODE, NOT_BOOTSTRAPPED, NOT_MOUNTED, BOOTSTRAPPING, MOUNTED } from \"./app.helpers\"\n\nimport { reroute } from '../navigations/reroute'\n\n/**\n * 微前端注册\n * @param {*} appName 应用名称\n * @param {*} loadApp 加载的应用\n * @param {*} activeWhen 当激活时会调用\n * @param {*} customProps 自定义参数\n */\n\n// 用来存放所有的应用\nconst apps = []\n\n// 维护应用所有状态 状态机\nexport function registerApplication(appName, loadApp, activeWhen, customProps) {\n    apps.push({ // 注册应用\n        name: appName,\n        loadApp,\n        activeWhen,\n        customProps,\n        status: NOT_LOADED\n    })\n    reroute() // 加载应用\n    // vue 一系列的生命周期\n}\n\nexport function getAppChanges() {\n    const appsToUnmount = [] // 要卸载的app\n    const appsToLoad = [] // 要加载的app\n    const appsToMount = [] // 需要挂载的\n    apps.forEach(app => {\n        // 需不需要被加载\n        const appSholdBeActive = shouldBeActive(app)\n        switch (app.status) { // toLoad\n            case NOT_LOADED:\n            case LOADING_SOURCE_CODE:\n                if (appSholdBeActive) {// 做判断了\n                    appsToLoad.push(app)\n                }\n                break\n            case NOT_BOOTSTRAPPED: // toMount\n            case BOOTSTRAPPING:\n            case NOT_MOUNTED:\n                if (appSholdBeActive) {\n                    appsToMount.push(app)\n                }\n                break;\n            case MOUNTED:  // unmount\n                if (!appSholdBeActive) {\n                    appsToUnmount.push(app)\n                }\n        }\n    });\n    return { appsToUnmount, appsToLoad, appsToMount }\n}","import 'css.escape'\n\nconst defaultOpts = {\n    Vue: null,\n    appOptions: null,\n    template: null\n}\n\nexport function singleSpaVue(userOpts) {\n    if (typeof userOpts !== \"object\") {\n        throw new Error('single-spa-vue requires a configuration object')\n    }\n\n    const opts = {\n        ...defaultOpts,\n        ...userOpts\n    }\n\n    if (!opts.Vue) {\n        throw Error(\"single-spa-vue must be passed opts.Vue\");\n    }\n\n    if (!opts.appOptions) {\n        throw Error(\"single-spa-vue must be passed opts.appOptions\");\n    }\n\n    if (\n        opts.appOptions.el &&\n        typeof opts.appOptions.el !== \"string\" &&\n        !(opts.appOptions.el instanceof HTMLElement)\n    ) {\n        throw Error(\n            `single-spa-vue: appOptions.el must be a string CSS selector, an HTMLElement, or not provided at all. Was given ${typeof opts\n                .appOptions.el}`\n        );\n    }\n\n    // Just a shared object to store the mounted object state\n    // key - name of single-spa app, since it is unique\n    let mountedInstances = {}\n\n    return {\n        bootstrap: bootstrap.bind(null, opts, mountedInstances),\n        mount: mount.bind(null, opts, mountedInstances),\n        unmount: unmount.bind(null, opts, mountedInstances),\n        update: update.bind(null, opts, mountedInstances)\n    }\n\n}\n\n/**\n * 启动函数\n * @param {*} opts \n */\nfunction bootstrap(opts) {\n    if (opts.loadRootComponent) {\n        return opts.loadRootComponent().then(root => (opts.rootComponent = root))\n    } else {\n        return Promise.resolve()\n    }\n}\n\n/**\n * 加载\n * @param {*} opts \n * @param {*} mountedInstances \n * @param {*} props \n */\nfunction mount(opts, mountedInstances, props) {\n    const instance = {}\n    return Promise.resolve().then(() => {\n        const appOptions = { ...opts.appOptions };\n        if (props.domElement && !appOptions.el) {\n            appOptions.el = props.domElement\n        }\n\n        let domEl\n        if (appOptions.el) {\n            if (typeof appOptions.el === \"string\") {\n                domEl = document.querySelector(appOptions.el)\n                if (!domEl) {\n                    throw Error(\n                        `If appOptions.el is provided to single-spa-vue, the dom element must exist in the dom. Was provided as ${appOptions.el}`\n                    )\n                }\n            } else {\n                domEl = appOptions.el\n                if (!domEl.id) {\n                    domEl.id = `single-spa-application:${props.name}`\n                }\n                appOptions.el = `#${CSS.escape(domEl.id)}`\n            }\n        } else {\n            const htmlId = `single-spa-application:${props.name}`\n            appOptions.el = `#${CSS.escape(htmlId)}`\n            domEl = document.getElementById(htmlId)\n            if (!domEl) {\n                domEl = document.createElement(\"div\")\n                domEl.id = htmlId\n                document.body.appendChild(domEl)\n            }\n        }\n\n        appOptions.el = appOptions.el + \" .single-spa-container\"\n\n        // single-spa-vue@>=2 always REPLACES the `el` instead of appending to it.\n        // We want domEl to stick around and not be replaced. So we tell Vue to mount\n        // into a container div inside of the main domEl\n        if (!domEl.querySelector(\".single-spa-container\")) {\n            const singleSpaContainer = document.createElement(\"div\")\n            singleSpaContainer.className = \"single-spa-container\"\n            domEl.appendChild(singleSpaContainer)\n        }\n\n        instance.domEl = domEl\n\n        if (!appOptions.render && !appOptions.template && opts.rootComponent) {\n            appOptions.render = h => h(opts.rootComponent)\n        }\n\n        if (!appOptions.data) {\n            appOptions.data = {}\n        }\n\n        appOptions.data = { ...appOptions.data, ...props }\n\n        instance.vueInstance = new opts.Vue(appOptions)\n        if (instance.vueInstance.bind) {\n            instance.vueInstance = instance.vueInstance.bind(instance.vueInstance)\n        }\n\n        mountedInstances[props.name] = instance\n\n        return instance.vueInstance\n    })\n}\n\n/**\n * 更新\n * @param {*} opts \n * @param {*} mountedInstances \n * @param {*} props \n */\nfunction update(opts, mountedInstances, props) {\n    return Promise.resolve().then(() => {\n        const instance = mountedInstances[props.name]\n        const data = {\n            ...(opts.appOptions.data || {}),\n            ...props\n        };\n        for (let prop in data) {\n            instance.vueInstance[prop] = data[prop]\n        }\n    })\n}\n\n\n/**\n * 卸载函数\n * @param {*} opts \n * @param {*} mountedInstances \n * @param {*} props \n */\nfunction unmount(opts, mountedInstances, props) {\n    return Promise.resolve().then(() => {\n        const instance = mountedInstances[props.name]\n        instance.vueInstance.$destroy()\n        instance.vueInstance.$el.innerHTML = \"\"\n        delete instance.vueInstance\n\n        if (instance.domEl) {\n            instance.domEl.innerHTML = \"\"\n            delete instance.domEl\n        }\n    })\n}"],"names":["NOT_LOADED","LOADING_SOURCE_CODE","NOT_BOOTSTRAPPED","BOOTSTRAPPING","NOT_MOUNTED","MOUNTING","MOUNTED","UNMOUNTING","shouldBeActive","app","activeWhen","window","location","started","start","reroute","flattenFnArray","fns","Array","isArray","props","reduce","p","fn","then","Promise","resolve","toLoadPromise","loadPromise","status","bootstrap","mount","unmount","loadApp","customProps","toUnmountPromise","toBootstrapPromise","toMountPromise","routingEventsListeningTo","capturedEventListeners","hashchange","popstate","urlReroute","forEach","addEventListener","originalAddEventListener","originalRemoveEventListener","removeEventListener","eventName","indexOf","some","listener","push","apply","arguments","filter","l","patchedUpdateState","updateState","methodName","urlBefore","href","urlAfter","PopStateEvent","history","pushState","replaceState","appsToLoad","appsToMount","appsToUnmount","getAppChanges","performAppChanges","loadApps","apps","all","map","console","log","unmountPromises","registerApplication","appName","name","appSholdBeActive","defaultOpts","Vue","appOptions","template","singleSpaVue","userOpts","Error","opts","el","HTMLElement","mountedInstances","bind","update","loadRootComponent","root","rootComponent","instance","domElement","domEl","document","querySelector","id","CSS","escape","htmlId","getElementById","createElement","body","appendChild","singleSpaContainer","className","render","h","data","vueInstance","prop","$destroy","$el","innerHTML"],"mappings":"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"}